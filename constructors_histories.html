<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<link rel="stylesheet" href="styles.css">

<body onload="loadAllData()">
<h1>Formula 1 World Championships (1950 - 2020)</h1>
<div id="page-1" class="page">
  <div id="page-1-description" class="page-description">
    <h3>All Constructors By Race Victories</h3>
    <p>Hover over a constructor's line for more details. Click on it for drilling down</p>
  </div>
  <div id="page-1-vis" class="float-container">

    <div id="constructor-detail" class="custom-tooltip closed">
      <table>
        <tr>
          <td>Constructor</td>
          <td id="td-constructor-name" class="data"></td>
        </tr>
        <tr>
          <td>Nationality</td>
          <td id="td-constructor-nationality" class="data"></td>
        </tr>
        <tr>
          <td>Total Races</td>
          <td id="td-constructor-races" class="data"></td>
        </tr>
        <tr>
          <td>Total Wins</td>
          <td id="td-constructor-wins" class="data"></td>
        </tr>
      </table>
    </div>
  </div>
</div>

</body>

<script id="page-1-script">
  var csv_root = "https://raw.githubusercontent.com/akshatvn/f1/main";
  var constructors, races, results;
  var raceById = {};
  var constructorById = {};
  var tooltips = document.querySelectorAll('.float-container .custom-tooltip');

  window.onmousemove = function (e) {
    var x = (e.clientX + 20) + 'px',
      y = (e.clientY + 20) + 'px';
    for (var i = 0; i < tooltips.length; i++) {
      tooltips[i].style.top = y;
      tooltips[i].style.left = x;
    }


    // var x1 = d3.event.pageX - document.getElementById("page-1-svg").getBoundingClientRect().x + 10;
    // var y1 = d3.event.pageY - document.getElementById("page-1-svg").getBoundingClientRect().y + 10;
    // console.log("x, y", x1,y1);

  };

  var margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

  var xScale = d3.scaleLinear().range([0, width]);
  var yScale = d3.scaleLinear().rangeRound([height, 0]);

  var yaxis = d3.axisLeft().scale(yScale);
  var xaxis = d3.axisBottom().scale(xScale);

  function make_x_gridlines() {
    return d3.axisBottom(xScale)
      .ticks(5)
  }

  // gridlines in y axis function
  function make_y_gridlines() {
    return d3.axisLeft(yScale)
      .ticks(5)
  }


  var svg = d3.select("#page-1-vis").append("svg")
    .attr("id", "page-1-svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
      "translate(" + margin.left + "," + margin.top + ")");

  svg.on("mouseover", function () {
    var coordinates = d3.mouse(this);
    var x1 = coordinates[0];
    var y1 = coordinates[1];
    console.log("x1,y1", x1, y1);
  });

  svg.append("g")
    .attr("class", "axis")
    .attr("class", "myXaxis")
    .attr("transform", "translate(0," + height + ")")
    .call(xaxis);

  svg.append("g")
    .attr("class", "axis")
    .attr("class", "myYaxis")
    .call(yaxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("dy", ".75em")
    .attr("y", 6)
    .style("text-anchor", "end")
    .text("Wins");
  ;

  var line = d3.line()
    .x(function (d) {
      return xScale(d.year);
    })
    .y(function (d) {
      return !d.wins ? null : yScale(d.wins);
    });


  svg.append("g")
    .attr("class", "grid")
    .attr("transform", "translate(0," + height + ")")
    .call(make_x_gridlines()
      .tickSize(-height)
      .tickFormat("")
    );


  svg.append("g")
    .attr("class", "grid")
    .call(make_y_gridlines()
      .tickSize(-width)
      .tickFormat("")
    );

  var focus = svg.append("g")
    .attr("class", "focus")
    .style("display", "none");

  focus.append("circle")
    .attr("r", 5);

  focus.append("rect")
    .attr("class", "tooltip")
    .attr("width", 100)
    .attr("height", 50)
    .attr("x", 10)
    .attr("y", -22)
    .attr("rx", 4)
    .attr("ry", 4);

  focus.append("text")
    .attr("class", "tooltip-year")
    .attr("x", 18)
    .attr("y", -2);

  focus.append("text")
    .attr("x", 18)
    .attr("y", 18)
    .text("Wins:");

  focus.append("text")
    .attr("class", "tooltip-wins")
    .attr("x", 60)
    .attr("y", 18);


  async function loadAllData() {
    if (!constructors) {
      constructors = await d3.csv(csv_root + "/data/constructors.csv");
      delete constructors.columns;
    }

    if (!races) {
      races = await d3.csv(csv_root + "/data/races.csv");
      delete races.columns;
    }

    if (!results) {
      results = await d3.csv(csv_root + "/data/results.csv");
      delete results.columns;
    }
    for (i = 0; i < races.length; i++) {
      raceById[races[i].raceId] = races[i];
    }
    for (i = 0; i < constructors.length; i++) {
      constructorById[constructors[i].constructorId] = constructors[i];
    }

    for (i = 0; i < results.length; i++) {
      constructorById[results[i].constructorId].wins = constructorById[results[i].constructorId].wins || 0;
      constructorById[results[i].constructorId].races = constructorById[results[i].constructorId].races || 0;
      constructorById[results[i].constructorId].races += 1;
      if (results[i].position === "1") {
        constructorById[results[i].constructorId].wins += 1;
      }
    }

    loadPage1();
  }

  function loadPage1() {
    page1DataByYear = {};
    page1DataByConstructor = {};
    for (i = 0; i < results.length; i++) {
      let result = results[i];
      if (result['position'] === "1") {
        let race = raceById[result.raceId];
        if (!race) {
          console.error("could not find race with ID ", result.raceId);
        } else {
          let resultYear = raceById[result.raceId].year;
          // let constructorName = constructorById[result.constructorId].name;
          page1DataByYear[resultYear] = page1DataByYear[resultYear] || {};
          page1DataByYear[resultYear][result.constructorId] = page1DataByYear[resultYear][result.constructorId] || 0;
          page1DataByYear[resultYear][result.constructorId] += 1
        }
      }
    }

    console.log("page1DataByYear", page1DataByYear);
    for (year in page1DataByYear) {
      for (constructorId in page1DataByYear[year]) {
        page1DataByConstructor[constructorId] = page1DataByConstructor[constructorId] || [];
        page1DataByConstructor[constructorId].push({
          year: year,
          wins: page1DataByYear[year][constructorId],
          // cumulativeWins:
        })
      }
    }

    console.log("page1DataByConstructor", page1DataByConstructor);

    // console.log("page1DataByConstructor", page1DataByConstructor);
    yearlyWinData = [];
    for (constructorId in page1DataByConstructor) {
      yearlyWinData.push({
          constructorId: constructorId,
          values: page1DataByConstructor[constructorId]
        }
      )
    }


    // page1Data = [];

    // console.log("page1Data", page1Data);

    console.log("yearlyWinData", yearlyWinData);
    // updateLineChart(yearlyWinData);

    // console.log("yearlyWinData", yearlyWinData);

    cumulativeWinData = [];
    cumulativeByConstructor = {};
    for (year in page1DataByYear) {
      for (constructorId in page1DataByYear[year]) {
        cumulativeByConstructor[constructorId] = cumulativeByConstructor[constructorId] || {};
        cumulativeByConstructor[constructorId]['so_far'] = cumulativeByConstructor[constructorId]['so_far'] || 0;
        cumulativeByConstructor[constructorId]['so_far'] += +page1DataByYear[year][constructorId];
        cumulativeByConstructor[constructorId]['values'] = cumulativeByConstructor[constructorId]['values'] || []
        cumulativeByConstructor[constructorId]['values'].push({
          year: year,
          wins: cumulativeByConstructor[constructorId]['so_far']
        })

      }

    }

    for (constructorId in cumulativeByConstructor) {
      cumulativeWinData.push({
          constructorId: constructorId,
          values: cumulativeByConstructor[constructorId]['values']
        }
      )
    }

    console.log("cumulativeByConstructor", cumulativeByConstructor);


    console.log("cumulativeWinData", cumulativeWinData);

    // window.setTimeout(function () {
    updateLineChart(cumulativeWinData, [handleMouseOver, handleMouseOut, handleMouseClick]);
    // updateLineChart(yearlyWinData, [handleMouseOver, handleMouseOut, handleMouseClick]);
    // updateLineChart(yearlyWinData, [handleMouseOver, handleMouseOut, handleMouseClick]);
    // }, 5000)

    // window.setTimeout(function () {
    //   updateLineChart(yearlyWinData);
    // }, 3000);
  }


  // [
  //   {
  //    constructorId: '51'
  //    values: [
  //      {'1950': 6}
  //       {}
  //    ]
  //   }
  // ]
  function updateLineChart(formattedData, mouseHandlers) {
    xScale.domain([
      d3.min(formattedData, function (c) {
        return d3.min(c.values, function (d) {
          return d.year;
        });
      }),
      d3.max(formattedData, function (c) {
        return d3.max(c.values, function (d) {
          return d.year;
        });
      })
    ]);

    yScale.domain([
      0,
      d3.max(formattedData, function (c) {
        return d3.max(c.values, function (d) {
          return d.wins + 4;
        });
      })
    ]);
    svg.selectAll(".myXaxis").transition()
      .duration(1500)
      .call(xaxis);

    svg.selectAll(".myYaxis")
      .transition()
      .duration(1500)
      .call(yaxis);

    const lines = svg.selectAll("chartLine")
      .data(formattedData)
      .enter()
      .append("g")
      .append("path")
      .attr("class", "chartLine")
      .attr("d", function (d) {
        return line(d.values);
      })
      .attr("constructor-id", function (d) {
        return d.constructorId;
      })
      .attr("stroke", function (d) {
        return constructorById[d.constructorId].color;
      })
      .attr("stroke-width", 3);
    ;


    lines
      .merge(lines)
      .transition()
      .duration(1500);


    lines.on("mouseover", mouseHandlers[0])
      .on("mouseout", mouseHandlers[1])
      .on("click", mouseHandlers[2]);

    // svg.append("rect")
    //   .attr("class", "overlay")
    //   .attr("width", width)
    //   .attr("height", height)
    //   .on("mouseover", function () {
    //     focus.style("display", null);
    //   })
    //   .on("mouseout", function () {
    //     focus.style("display", "none");
    //   })
    //   .on("mousemove", mousemove);

    // function mousemove() {
    //   // var bisectDate = d3.bisector(function (d) {
    //   //   return d.year;
    //   // }).left;
    //   // var x0 = xScale.invert(d3.mouse(this)[0]);
    //   // console.log("x0", x0);
    //   // var i = bisectDate(formattedData, x0, 1);
    //   // console.log("i", i);
    //   // var d0 = formattedData[i - 1];
    //   // console.log("d0", d0);
    //   // var d1 = formattedData[i];
    //   // console.log("d1", d1);
    //   // var d = x0 - d0.year > d1.year - x0 ? d1 : d0;
    //   // console.log("d", d);
    //   //
    //   // focus.attr("transform", "translate(" + xScale(d.year) + "," + yScale(d.wins) + ")");
    //   // focus.select(".tooltip-year").text((d.year));
    //   // focus.select(".tooltip-wins").text((d.wins));
    // }
    const annotations = [
      {
        note: {
          label: "Just before Shumacher came in",
          title: "Ferrari's slowest years"
        },
        x: 536,
        y: 254,
        dy: -100,
        dx: -100
      },
      {
        note: {
          label: "More than 10 wins every year since 2014!",
          title: "Mercedes is back"
        },
        x: 800,
        y: 428,
        dy: -60,
        dx: -40
      },
      {
        note: {
          title: "Vettel quits red bull"
        },
        x: 804,
        y: 362,
        dy: -140,
        dx: -10
      }
    ];

// Add annotation to the chart
    const makeAnnotations = d3.annotation()
      // .editMode(true)
      .annotations(annotations);
    svg
      .append("g")
      .call(makeAnnotations)
  }

  function handleMouseClick(d, i) {
    let split_path = window.location.pathname.split("/");
    let redirectPath = split_path.slice(0, split_path.length - 1);
    redirectPath.push("constructor_drivers.html");
    window.location = redirectPath.join("/") + `?c=${this.getAttribute("constructor-id")}`;
  }

  function handleMouseOver(d, i) {
    document.getElementById('constructor-detail').classList.remove('closed');
    populateCurrentConstructorTable(constructorById[d.constructorId]);
  }

  function populateCurrentConstructorTable(selectedConstructor) {
    document.getElementById("td-constructor-name").innerHTML = selectedConstructor.name;
    document.getElementById("td-constructor-nationality").innerHTML = selectedConstructor.nationality;
    document.getElementById("td-constructor-races").innerHTML = selectedConstructor.races;
    document.getElementById("td-constructor-wins").innerHTML = selectedConstructor.wins;
  }

  function handleMouseOut(d, i) {
    document.getElementById('constructor-detail').classList.add('closed');
    selectedConstructor = null;
    clearCurrentConstructorTable();
  }

  function clearCurrentConstructorTable() {
    document.getElementById("td-constructor-name").innerHTML = '';
    document.getElementById("td-constructor-nationality").innerHTML = '';
    document.getElementById("td-constructor-races").innerHTML = '';
    document.getElementById("td-constructor-wins").innerHTML = '';
  }
</script>
